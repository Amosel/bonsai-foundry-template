version: "3.9"
services:
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    profiles: ["main", "setup"]
    expose:
      - "8545"
    ports:
      - "8545:8545"
    command: ["anvil --host 0.0.0.0 --port 8545"]

  relayer:
    image: relayer:latest
    profiles: ["main"]
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      - API_KEY=${BONSAI_API_KEY}
      - RUST_LOG=info
    entrypoint:
      - ethereum-relay
      - --bonsai-url
      - ${BONSAI_API_URL}
      - --proxy-address
      - ${RELAY_CONTRACT_ADDRESS}
      - --eth-node-url
      - "ws://anvil:8545"
      - --wallet-key-identifier
      - ${PRIVATE_KEY}
    depends_on:
      - anvil

  contract-deployer:
    image: ghcr.io/foundry-rs/foundry:latest
    profiles: ["setup"]
    working_dir: /src
    volumes:
      - .:/src
    command: ["forge create --force --rpc-url http://anvil:8545 --private-key ${PRIVATE_KEY} ${CONTRACT_PATH} --constructor-args ${CONSTRUCTOR_ARGS}"]
    depends_on:
      - anvil
